class Config {
  #staticConfig;
  #configSchema;
  #defaultConfig;

  constructor(values = {}) {
    this.setConfig(values);
  }

  setConfig(values) {
    Object.assign(this, values);
  }

  get staticConfig() {
    if (!this.#staticConfig) {
      this.#staticConfig = {
        VERSION: "1.0.0",
        env: process.env.NODE_ENV || "development"
      };
    }
    return this.#staticConfig;
  }

  get defaultConfig() {
    if (!this.#defaultConfig) {
      this.#defaultConfig = {
        foo: 'bar',
        baz: true,
        version: this.staticConfig.VERSION,
        environment: this.staticConfig.env
      };
    }
    return this.#defaultConfig;
  }

  get configSchema() {
    return {
      type: 'object',
      properties: {
        foo: { type: 'string' },
        baz: { type: 'boolean' },
        version: { type: 'string' },
        environment: { type: 'string' }
      },
      required: ['foo', 'baz', 'version', 'environment']
    };
  }

  validate() {
    try {
      const schema = this.configSchema;
      const validator = new (require('jsonschema').Validator)();
      validator.checkSchema(schema);
      validator.validate(this, schema);
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
  }

  static getDefaultConfig() {
    return new Config().defaultConfig;
  }
}

class LifecycleEvent {
  #event;

  constructor(event) {
    this.#event = event;
  }

  get event() {
    return this.#event;
  }
}

class LifecycleHandler {
  constructor(handler) {
    this.handler = handler;
  }

  bind(target = this) {
    return this.handler.bind(target);
  }

  execute() {
    this.handler();
  }
}

class EventHandler {
  #handlers = new Map();

  on(event, handler) {
    if (!this.#handlers.has(event)) {
      this.#handlers.set(event, new Set());
    }
    this.#handlers.get(event).add(handler);
  }

  off(event, handler) {
    if (this.#handlers.has(event)) {
      this.#handlers.get(event).delete(handler);
    }
  }

  trigger(event) {
    if (this.#handlers.has(event)) {
      for (const handler of this.#handlers.get(event)) {
        handler();
      }
    }
  }

  offGlobal(handler) {
    for (const handlers of this.#handlers.values()) {
      handlers.delete(handler);
    }
  }
}

class NexusCore {
  #lifecycle = new LifecycleHandler(() => {});
  #status;
  #eventManager = new EventHandler();
  #config;

  get lifecycle() {
    return this.#lifecycle;
  }

  get status() {
    return this.#status;
  }

  set status(value) {
    this.#status = value;
    if (this.#status !== 'INIT') {
      console.log(`NexusCore instance is ${value}.`);
      if (value === 'SHUTDOWN') {
        this.#lifecycle.handler = () => {};
        this.#eventManager.off('SHUTDOWN');
        this.#eventManager = new EventHandler();
      }
    }
    if (this.#status !== 'INIT' && this.#status !== 'SHUTDOWN') {
      this.#eventManager.off('INIT');
    }
  }

  get lifeCycleStatus() {
    return {
      configured: this.#lifecycle.handler === 'CONFIGURED',
      loaded: this.#lifecycle.handler === 'LOADED',
      shuttingDown: this.#lifecycle.handler === 'SHUTTING_DOWN'
    };
  }

  configure(config) {
    this.validateConfig(config);
    this.#lifecycle.handler = () => 'CONFIGURED';
    config.version = NexusCore.VERSION;
    config.environment = process.env.NODE_ENV || 'development';
    this.#config = config;
    this.#eventManager.trigger('CONFIGURED');
  }

  validateConfig(config) {
    const schema = Config.getDefaultConfig().configSchema;
    try {
      const validator = new (require('jsonschema').Validator)();
      validator.checkSchema(schema);
      validator.validate(config, schema);
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
  }

  on(event, handler) {
    this.#eventManager.on(event, handler);
  }

  off(event, handler) {
    this.#eventManager.off(event, handler);
  }

  offGlobal(handler) {
    this.#eventManager.offGlobal(handler);
  }

  executeLifecycleEvent(event) {
    if (typeof this.#lifecycle.handler === 'function' && this.#lifecycle.handler() === event) {
      const lifecycleHandler = new LifecycleHandler(() => {});
      this.#lifecycle.handler = lifecycleHandler.bind(this);
      this.#lifecycle.handler();
    }
  }

  async load() {
    try {
      console.log('Loading...');
      await new Promise(resolve => setTimeout(resolve, 1000));
      console.log('Loading complete...');
      this.#lifecycle.handler = () => 'LOADED';
      this.#eventManager.trigger('LOAD');
    } catch (e) {
      console.error('Load error:', e);
    }
  }

  async shutdown() {
    try {
      if (typeof this.#lifecycle.handler === 'function' && this.#lifecycle.handler() === 'INIT') {
        console.log('Shutdown initiated...');
        this.#lifecycle.handler = () => 'SHUTTING_DOWN';
        await new Promise(resolve => setTimeout(resolve, 1000));
        console.log('Shutdown complete...');
        this.status = 'SHUTDOWN';
        this.#eventManager.trigger('SHUTDOWN');
      }
    } catch (e) {
      console.error('Shutdown error:', e);
    }
  }

  async start() {
    const startMethodOrder = ['configure', 'load', 'shutdown'];
    for (const methodName of startMethodOrder) {
      if (this[methodName] instanceof Function && !methodName.startsWith('__')) {
        await this[methodName]();
      }
    }
  }

  async destroy() {
    this.status = 'DESTROYED';
    this.#eventManager = new EventHandler();
  }
}

NexusCore.VERSION = "1.0.0";

const nexusCore = new NexusCore();
nexusCore.on('DESTROYED', () => {
  console.log("NexusCore instance destroyed.");
});
nexusCore.on('CONFIGURED', () => {
  console.log("Configured...");
});
nexusCore.on('LOAD', () => {
  console.log("Loaded...");
});
nexusCore.configure(Config.getDefaultConfig());
nexusCore.start();
nexusCore.load();
nexusCore.shutdown();
nexusCore.destroy();