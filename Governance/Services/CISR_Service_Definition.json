class Config {
  #schema;
  #values;
  #staticConfigSchema;
  #defaultConfig;

  static get staticConfig() {
    return {
      VERSION: "1.0.0",
      env: process.env.NODE_ENV || "development"
    };
  }

  static get defaultConfigSchema() {
    return {
      $schema: "https://json-schema.org/draft/2020-12/schema",
      type: "object",
      properties: {
        foo: { type: "string" },
        baz: { type: "boolean" }
      },
      required: ["foo", "baz"]
    };
  }

  static get defaultConfig() {
    return {};
  }

  configure({ values = {} } = {}) {
    this.#validateConfig(values);
    this.#values = values;
    return this;
  }

  #validateConfig(config) {
    try {
      const validator = new (require('jsonschema').validate)({ schema: this.#staticConfigSchema, data: config });
      validator.errors = [];
      validator.check();
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
  }

  defaultConfig(value = Config.defaultConfig) {
    this.#values = value;
    return this;
  }
}

class LifecycleEvent {
  #event;
  #instance;

  constructor(instance, event) {
    this.#event = event;
    this.#instance = instance;
  }

  get instance() {
    return this.#instance;
  }

  get event() {
    return this.#event;
  }

  get isBound() {
    return this.handler !== undefined;
  }

  bind(target) {
    if (target) {
      this.handler = this.handler.bind(target);
    }
  }

  execute() {
    if (this.handler) {
      this.handler();
    }
  }

  set handler(value) {
    this.handler = value;
  }
}

class NexusCore {
  #lifecycle;
  #status;
  #config;
  #validateConfig;

  static get defaultConfig() {
    return Config.defaultConfig();
  }

  constructor() {
    this.#lifecycle = {
      CONFIGURED: new LifecycleEvent(this, 'CONFIGURED'),
      LOADED: new LifecycleEvent(this, 'LOADED'),
      SHUTTING_DOWN: new LifecycleEvent(this, 'SHUTTING_DOWN'),
      DESTROYED: new LifecycleEvent(this, 'DESTROYED'),
      SHUTDOWN: new LifecycleEvent(this, 'SHUTDOWN')
    };
    this.#status = 'INIT';
    this.#config = {};
    this.#validateConfig = (config) => {
      try {
        const validator = new (require('jsonschema').validate)({ schema: Config.defaultConfigSchema, data: config });
        validator.errors = [];
        validator.check();
      } catch (e) {
        console.error('Config validation error:', e);
        throw e;
      }
    };
  }

  get status() {
    return this.#status;
  }

  set status(value) {
    if (value !== this.#status) {
      const currentValue = this.#status;
      if (value === 'DESTRUCTED') {
        this.#lifecycle.DESTROYED.handler = this.#lifecycle.DESTROYED.handler.bind(this);
        this.#lifecycle.DESTROYED.handler.execute();
        this.#lifecycle.DESTROYED.handler = undefined;
      } else if (value === 'SHUTDOWN') {
        this.#lifecycle.SHUTDOWN.handler = this.#lifecycle.SHUTDOWN.handler.bind(this);
        this.#lifecycle.SHUTDOWN.handler.execute();
        this.#lifecycle.SHUTDOWN.handler = undefined;
      }
      if (currentValue === 'INIT' && value !== 'INIT') {
        this.#lifecycle.CONFIGURED.handler = this.#lifecycle.CONFIGURED.handler.bind(this);
        this.#lifecycle.CONFIGURED.handler.execute();
        this.#lifecycle.CONFIGURED.handler = undefined;
      }
      this.#status = value;
      this.#lifecycle.LOADED.handler && this.#lifecycle.LOADED.handler.execute();
    }
  }

  get lifecycle() {
    return this.#lifecycle;
  }

  on(event, handler) {
    this.#lifecycle[event].handler = handler;
    this.#lifecycle[event].bind(this.instance);
    return this;
  }

  configure({ values = {} } = {}) {
    try {
      this.#validateConfig(values);
      this.#config = values;
      this.status = 'CONFIGURED';
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
    return this;
  }

  load() {
    this.#lifecycle.LOADED.handler = this.#lifecycle.LOADED.handler.bind(this);
    this.#lifecycle.LOADED.handler.execute();
    this.status = 'LOADED';
    return this;
  }

  shutDown() {
    this.status = 'SHUTTING_DOWN';
    this.#lifecycle.SHUTDOWN.execute();
    return this;
  }

  start() {
    const startMethodOrder = ["configure", "load", "shutDown"];
    const methods = ['configure', 'load', 'shutDown'];
    for (const method of methods) {
      const methodFunc = methods.find(methodName => methodName === method).bind(this);
      if (methodFunc instanceof Function) {
        methodFunc();
      }
    }
    return this;
  }

  destroy() {
    this.#lifecycle.DESTROYED.handler = this.#lifecycle.DESTROYED.handler.bind(this);
    this.#lifecycle.DESTROYED.handler.execute();
    this.status = 'DESTRUCTED';
    return this;
  }
}

const nexusCore = new NexusCore();
nexusCore.on('DESTROYED', () => {
  console.log("NexusCore instance destroyed.");
});
nexusCore.configure(NexusCore.defaultConfig())
  .load()
  .shutDown()
  .destroy();