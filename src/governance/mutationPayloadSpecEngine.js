// Mutation Payload Specification Engine (MPSE)
// Purpose: Enforces rigid structural and type compliance for all mutation payloads 
// before EPDP C (P-01 Trust Adjudication) is initiated. This guarantees a validated 
// operational contract is presented to the trust calculus system.

// --- Dependencies ---
const { validateSchema } = require('@governance/payloadSchemaValidator');
// Load the schema definitions dynamically, decoupling selection from import.
const payloadSchemas = require('@config/schemas/mutationPayload.json'); 
const { PayloadSchemaError } = require('./errors/PayloadSchemaError'); 
const Logger = require('@utils/Logger'); 

const SUBSYSTEM_ID = 'MPSE';

class MutationPayloadSpecEngine {
    /**
     * Initializes the MPSE with a specific schema version.
     * @param {string} schemaKey - The key corresponding to the required schema version (e.g., 'MPSE_SCHEMA_V1').
     */
    constructor(schemaKey = 'MPSE_SCHEMA_V1') {
        if (!payloadSchemas[schemaKey]) {
             // Architectural check: Ensure critical schema dependency exists
             throw new Error(`[${SUBSYSTEM_ID}] Initialization failure: Specified schema key '${schemaKey}' not found in configuration.`);
        }
        this.schema = payloadSchemas[schemaKey];
        this.schemaVersion = schemaKey;
        Logger.info(`[${SUBSYSTEM_ID}] Initialized with schema version: ${this.schemaVersion}. Awaiting mutation proposals.`);
    }

    /**
     * Enforces rigid structural specification on the mutation payload.
     * @param {object} payload - The raw mutation proposal generated by M-02.
     * @returns {object} validatedPayload - The input payload, guaranteed compliant.
     * @throws {PayloadSchemaError} if validation fails.
     */
    enforceSpecification(payload) {
        // High-frequency optimization: Use trace/debug for operational logging
        Logger.trace(`[${SUBSYSTEM_ID}] -> ENFORCE: Starting specification check (V${this.schemaVersion}).`);
        
        const validationResult = validateSchema(payload, this.schema);

        if (!validationResult.isValid) {
            // Aggregate a clear, human-readable summary string for simpler logging
            const errorSummary = validationResult.errors
                .map(e => e.path ? `[${e.path}]: ${e.message}` : e.message)
                .join('; ');
            
            Logger.warn(`[${SUBSYSTEM_ID}] Validation failed (V${this.schemaVersion}). Breach: ${errorSummary}`);
            
            // Throw custom error, providing the structured error array (validationResult.errors)
            // This relies on the proposed evolution of the PayloadSchemaError component.
            throw new PayloadSchemaError(
                `Structural breach identified in mutation payload (V${this.schemaVersion}).`,
                payload, 
                errorSummary,
                validationResult.errors
            );
        }

        Logger.verbose(`[${SUBSYSTEM_ID}] Payload structurally compliant. Forwarding to P-01.`);
        return payload;
    }
}

// Export a singleton instance using the standard configuration key
module.exports = new MutationPayloadSpecEngine('MPSE_SCHEMA_V1');