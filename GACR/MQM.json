class Config {
    #staticConfig = {
        VERSION: "1.0.0",
        env: process.env.NODE_ENV || "development"
    };

    constructor(values = {}) {
        this.#validateConfig(values);
        Object.freeze(this.#config = values);
    }

    static get defaultConfig() {
        return { ...Config.#staticConfig, ...{
            foo: 'bar',
            baz: true,
        }};
    }

    static get configSchema() {
        return {
            type: 'object',
            properties: {
                VERSION: { type: 'string' },
                env: { type: 'string' },
                foo: { type: 'string' },
                baz: { type: 'boolean' }
            },
            required: ['VERSION', 'env', 'foo', 'baz']
        };
    }

    static get staticConfig() {
        return Config.#staticConfig;
    }

    static #validateConfig(config) {
        const schema = Config.configSchema;
        try {
            const validator = new (require('jsonschema').Validator)();
            validator.checkSchema(schema);
            validator.validate(config, schema);
        } catch (e) {
            throw new Error(`Config validation error: ${e}`);
        }
    }
}

class LifecycleEvent {
    #event;

    constructor(event) {
        this.#event = event;
    }

    get event() {
        return this.#event;
    }
}

class LifecycleHandler {
    #handler;

    constructor(handler) {
        if (typeof handler !== 'function') {
            throw new Error("Handler must be a function");
        }
        this.#handler = handler;
    }

    bind(target = this) {
        this.#handler = this.#handler.bind(target);
    }

    execute(...args) {
        this.#handler(...args);
    }

    unbind() {
        this.#handler = null;
    }
}

class NexusCore {
    #privateConfig = {};
    #privateLifecycle = {
        configured: false,
        loaded: false,
        shuttingDown: false
    };
    #privateStatus = NexusCore.Status.INIT;
    #configLock = false;

    constructor() {
        this.#watchLifecycle();
    }

    get config() {
        return Object.freeze(this.#privateConfig);
    }

    get status() {
        return this.#privateStatus;
    }

    set status(value) {
        const currentValue = this.#privateStatus;
        const lifecycle = this.#privateLifecycle;
        if (value !== currentValue) {
            this.#privateStatus = value;
            console.log(`NexusCore instance status changed to ${value}`);
            if (value === NexusCore.Status.SHUTDOWN) {
                this.#privateLifecycle.shuttingDown = false;
                this.#privateLifecycle.configured = false;
                this.#privateLifecycle.loaded = false;
            }
        }
    }

    get lifecycle() {
        return Object.freeze(this.#privateLifecycle);
    }

    static get Status() {
        return {
            INIT: "INIT",
            CONFIGURED: "CONFIGURED",
            LOADED: "LOADED",
            SHUTTING_DOWN: "SHUTTING_DOWN",
            RUN: "RUN",
            SHUTDOWN: "SHUTDOWN",
            DESTROYED: "DESTROYED"
        };
    }

    async #validateConfig(config) {
        await Config.#validateConfig(config);
        this.#privateConfig = config;
    }

    async configure(config) {
        if (this.#configLock) {
            throw new Error("Config cannot be set while NexusCore instance is in use");
        }
        this.#configLock = true;
        try {
            await this.#validateConfig(config);
            this.#privateLifecycle.configured = true;
            await this.#executeLifecycleEvent(NexusCore.Status.CONFIGURED);
            this.#privateLifecycle.LCONFIGURED_observed = this.#observeLifecycleEvent(NexusCore.Status.CONFIGURED);
        } finally {
            this.#configLock = false;
        }
        return this;
    }

    async load() {
        try {
            console.log("Loading...");
            await new Promise(resolve => setTimeout(resolve, 1000));
            console.log("Loading complete...");
            this.#privateLifecycle.loaded = true;
            await this.#executeLifecycleEvent(NexusCore.Status.LOADED);
            this.#privateLifecycle.LOADED_observed = this.#observeLifecycleEvent(NexusCore.Status.LOADED);
        } catch (e) {
            console.error('Load error:', e);
        }
        return this;
    }

    async shutdown() {
        if (!this.#privateLifecycle.shuttingDown) {
            console.log("Shutdown initiated...");
            this.#privateLifecycle.shuttingDown = true;
            await this.#executeLifecycleEvent(NexusCore.Status.SHUTTING_DOWN);
            this.#privateLifecycle.SHUTTING_DOWN_observed = this.#observeLifecycleEvent(NexusCore.Status.SHUTTING_DOWN);
        } else {
            console.log("Shutdown already initiated");
        }
        return this;
    }

    async start() {
        if (this.status !== NexusCore.Status.INIT) {
            throw new Error("NexusCore instance is already running");
        }
        const startMethodOrder = ["configure", "load", "shutdown"];
        for (const methodName of startMethodOrder) {
            if (this[methodName] instanceof Function) {
                await this[methodName].call(this);
            }
        }
        this.status = NexusCore.Status.RUN;
    }

    async destroy() {
        this.#privateLifecycle = {
            configured: false,
            loaded: false,
            shuttingDown: false,
            LCONFIGURED_observed: null,
            LOADED_observed: null,
            SHUTTING_DOWN_observed: null,
        };
        this.#privateStatus = NexusCore.Status.DESTROYED;
        this.#privateConfig = {};
    }

    #executeLifecycleEvent(event) {
        if (this.#privateLifecycle[event]) {
            this.#privateLifecycle[event].unbind().execute();
        }
    }

    #observeLifecycleEvent(event) {
        return new LifecycleHandler(() => {
            this.#privateLifecycle[event].unbind();
        });
    }

    async on(event, handler) {
        if (this.#privateLifecycle[event]) {
            throw new Error(`Lifecycle event ${event} is already observed`);
        }
        if ((event) !== 'LCONFIGURED_observed' && (event) !== 'LOADED_observed' && (event) !== 'SHUTTING_DOWN_observed' && (event) !== 'configured' && (event) !== 'loaded' && (event) !== 'shutting_down') {
            const lifecycleHandler = new LifecycleHandler(async () => {
                this.#privateLifecycle[event].unbind();
            });
            this.#privateLifecycle[event] = lifecycleHandler;
        } else {
            const lifecycleHandler = await new LifecycleHandler(async () => {
                this.#privateLifecycle[event].unbind();
            }).bind();
            this.#privateLifecycle[event] = lifecycleHandler;
        }
        if (event === 'configured' || event === 'loaded' || event === 'shutting_down') {
            await this.#observeLifecycleEvent(event);
        }
        return lifecycleHandler;
    }

    #watchLifecycle() {
        const observe = this.on.bind(this);
        const lifecycle = this.#privateLifecycle;
        [
            "LCONFIGURED_observed",
            "LOADED_observed",
            "SHUTTING_DOWN_observed",
        ].forEach((event) => {
            lifecycle[event] = null;
        });
        [
            "CONFIGURED",
            "LOADED",
            "SHUTTING_DOWN",
            "DESTROYED"
        ].forEach((event) => {
            const observedEvent = `${event}_observed`;
            lifecycle[observedEvent] = observe(event);
            this.#privateLifecycle[event] = lifecycle[event];
        });
    }
}

async function main() {
    const nexusCore = new NexusCore();
    const lifecycleHandler = await nexusCore.on('DESTROYED', () => {
        console.log("NexusCore instance destroyed.");
    });
    
    nexusCore.start();
    await nexusCore.load();
    await nexusCore.shutdown();
    nexusCore.destroy();
    console.log(nexusCore.lifecycle);
}

main();