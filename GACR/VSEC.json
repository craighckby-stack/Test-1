import { Validator } from 'jsonschema';

class Config {
  #staticConfig;
  #defaultConfig;
  #configSchema;
  #config;

  configure() {
    this.#config = this.#mergeConfig(this.#defaultConfig, this.#staticConfig);
  }

  loadConfig(config) {
    this.#config = this.#validateConfig(config);
  }

  shutdownConfig() {
    this.#config = null;
  }

  get staticConfig() {
    return this.#staticConfig;
  }

  get defaultConfig() {
    return this.#defaultConfig;
  }

  get config() {
    return this.#config;
  }

  get configSchema() {
    return this.#configSchema;
  }

  #mergeConfig(target, ...sources) {
    sources.forEach(source => Object.assign(target, source));
    return target;
  }

  #validateConfig(values) {
    if (typeof values !== 'object') {
      throw new Error('Invalid configuration: must be an object');
    }
    const validator = new Validator();
    try {
      validator.checkSchema(this.#configSchema);
      validator.validate(values, this.#configSchema);
      return values;
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
  }

  async validate() {
    this.#validateConfig(this.#config);
  }
}

class LifecycleEvent {
  constructor(event) {
    this.event = event;
  }
}

class LifecycleHandler {
  constructor(handler) {
    this.handler = handler;
    this.binded = false;
  }

  bind(target = this) {
    if (!this.binded) {
      this.handler = this.handler.bind(target);
      this.binded = true;
    }
  }

  execute() {
    this.handler();
  }
}

class NexusCore {
  #status;
  #lifecycle;
  #config;

  constructor() {
    this.#status = "INIT";
    this.#lifecycle = {
      lifecycleEvents: new Map(),
      configured: false,
      loaded: false,
      shuttingDown: false
    };
  }

  get status() {
    return this.#status;
  }

  get lifecycle() {
    return this.#lifecycle;
  }

  get config() {
    return this.#config;
  }

  set config(value) {
    this.#config = value;
  }

  async configure(config = new Config()) {
    await config.validate();
    this.#status = "CONFIGURED";
    this.#lifecycle.configured = true;
    if (this.#lifecycle.lifecycleEvents.has("CONFIGURED")) {
      this.#lifecycle.lifecycleEvents.get("CONFIGURED").bind(this).execute();
    }
    this.#config = config;
  }

  async destroyConfig() {
    this.#config = null;
  }

  on(event, handler) {
    const lifecycleHandler = new LifecycleHandler(handler);
    this.#lifecycle.lifecycleEvents.set(event, lifecycleHandler);
  }

  get lifecycleEvents() {
    return this.#lifecycle.lifecycleEvents;
  }

  async executeLifecycleEvent(event) {
    if (this.#lifecycle.lifecycleEvents.has(event)) {
      this.#lifecycle.lifecycleEvents.get(event).bind(this).execute();
    }
  }

  async load() {
    try {
      console.log("Loading...");
      await new Promise(resolve => setTimeout(resolve, 1000));
      console.log("Loading complete...");
      this.#lifecycle.loaded = true;
      this.executeLifecycleEvent("LOADED");
    } catch (e) {
      console.error('Load error:', e);
    }
  }

  async shutdown() {
    if (!this.#lifecycle.shuttingDown) {
      console.log("Shutdown initiated...");
      this.#lifecycle.shuttingDown = true;
      this.#status = 'SHUTTING_DOWN';
      this.executeLifecycleEvent("SHUTTING_DOWN");
      console.log("Shutdown complete...");
      this.#lifecycle.shuttingDown = false;
      this.#status = 'SHUTDOWN';
      this.#lifecycle.loaded = false;
      this.#lifecycle.configured = false;
      await this.destroyConfig();
    }
  }

  async start() {
    await this.configure();
    await this.load();
    this.#status = "RUNNING";
  }

  async destroy() {
    this.#status = "DESTROYED";
    this.#lifecycle = {
      lifecycleEvents: new Map(),
      configured: false,
      loaded: false,
      shuttingDown: false
    };
    this.#config = null;
  }
}

const nexusCore = new NexusCore();

const staticConfig = {
  VERSION: "1.0.0",
  env: process.env.NODE_ENV || "development"
};

nexusCore.on("INIT", async () => {
  console.log("NexusCore instance initialized.");
});

nexusCore.on("CONFIGURED", async () => {
  console.log("NexusCore instance configured.");
});

nexusCore.on("LOADED", async () => {
  console.log("NexusCore instance loaded.");
});

nexusCore.on("SHUTTING_DOWN", async () => {
  console.log("NexusCore instance is shutting down...");
});

nexusCore.on("SHUTDOWN", async () => {
  console.log("NexusCore shutdown completed.");
});

nexusCore.configure({ foo: 'bar', baz: true });

nexusCore.start();
nexusCore.shutdown();
nexusCore.destroy();


The code has been refactored to adhere to advanced NexusCore patterns, lifecycle management (configure, load, shutdown), and robust encapsulation. The Config class has been modified to encapsulate the configuration process, while the LifecycleHandler has been improved to bind the handler to the correct context. The NexusCore class has been refactored to use a Map to store lifecycle events, and the start method now properly awaits the configuration process. The destroy method has been updated to clear the lifecycle events and configuration.