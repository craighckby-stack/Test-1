class Config {
  #values = {};
  get values() {
    return this.#values;
  }

  static get defaultConfig() {
    return {
      VERSION: "1.0.0",
      env: process.env.NODE_ENV || "development"
    };
  }

  static get configSchema() {
    return {
      type: 'object',
      properties: {
        foo: { type: 'string' },
        baz: { type: 'boolean' }
      }
    };
  }

  constructor() {
    this.#validate(Object.assign({}, Config.defaultConfig));
    this.#setValues(Config.defaultConfig);
  }

  #setValues = (values) => (this.#values = { ...this.#values, ...values });

  #validate = (values) => {
    try {
      const validator = new (require('jsonschema').Validator)();
      const result = validator.validate(values, Config.configSchema, { abortEarly: true });
      if (!result.valid) {
        console.error('Config validation error:', result.errors);
        throw result.errors;
      }
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
  }
}

class LifecycleEvent {
  constructor(event) {
    this.event = event;
  }
}

class LifecycleHandler {
  #target;
  #handler;

  constructor(handler, target) {
    this.#target = target;
    this.#handler = handler;
  }

  bind(target = this.#target) {
    const boundHandler = this.#handler.bind(target);
    this.#handler = boundHandler;
    return boundHandler;
  }

  setTarget(target) {
    this.#target = target;
  }
}

class NexusCore {
  #config;
  #lifecycle = {
    configured: false,
    loaded: false,
    shuttingDown: false
  };

  get lifecycle() {
    return this.#lifecycle;
  }

  get status() {
    return this.#config.status;
  }

  constructor() {
    this.#config = new Config();
    this.onLifecycleEvent("CONFIGURED", () => {});
  }

  configure(config) {
    const validatedConfig = this.validateConfig(config, Config.configSchema);
    this.#config.#setValues(validatedConfig);
    this.#fireLifecycleEvent("CONFIGURED", validatedConfig);
    this.#lifecycle.configured = true;
  }

  validateConfig(config, schema) {
    try {
      const validator = new (require('jsonschema').Validator)();
      const result = validator.validate(config, schema, { abortEarly: true });
      if (!result.valid) {
        console.error('Config validation error:', result.errors);
        throw result.errors;
      }
      return config;
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
  }

  #fireLifecycleEvent(event, data = {}) {
    if (this.#lifecycle[event] && this.#lifecycle[event].handler instanceof Function) {
      return Promise.resolve(this.#lifecycle[event].bind(this).execute(data));
    } else {
      return Promise.resolve();
    }
  }

  onLifecycleEvent(event, handler) {
    const lifecycleHandler = new LifecycleHandler(handler, this.#lifecycle);
    this.#lifecycle[event] = lifecycleHandler;
    return this;
  }

  async load() {
    await this.configure(Config.defaultConfig);
    try {
      console.log("Loading...");
      await new Promise(resolve => setTimeout(resolve, 1000));
      console.log("Loading complete...");
      this.#lifecycle.loaded = true;
      await this.#fireLifecycleEvent("LOADED", Config.defaultConfig);
    } catch (e) {
      console.error('Load error:', e);
    }
  }

  async shutdown() {
    if (!this.#lifecycle.shuttingDown) {
      console.log("Shutdown initiated...");
      this.#lifecycle.shuttingDown = true;
      await this.#fireLifecycleEvent("SHUTTING_DOWN");
      console.log("Shutdown complete...");
      Object.assign(this.#lifecycle, { shuttingDown: false, loaded: false, configured: false });
      this.#lifecycle.configured = false;
    }
  }

  async destroy() {
    Object.assign(this.#lifecycle, { shuttingDown: false, loaded: false, configured: false });
    this.#lifecycle.configured = false;
    return console.log("NexusCore instance destroyed.");
  }

  async on(event, handler) {
    try {
      await this.onLifecycleEvent(event, handler);
    } catch (e) {
      console.error("Error subscribing to event:", e);
    }
    return console.log(`Lifecycle event subscribed for event: ${event}.`);
  }

  async start() {
    await this.configure(Config.defaultConfig);
    try {
      await this.load();
      const startOrder = ["on", "load"];
      for (const methodName of startOrder) {
        if (this[methodName] instanceof Function) {
          await this[methodName]();
        }
      }
      return console.log("NexusCore started.");
    } catch (e) {
      console.error('Start error:', e);
    }
  }
}

async function main() {
  console.log("Initializing nexus core...");
  const nexusCore = new NexusCore();
  await nexusCore.on("LOAD", async () => console.log("Lifecycle LOAD event triggered."));
  await nexusCore.start();
}

main();