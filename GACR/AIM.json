class Config {
  #[private] values = {};
  get values() {
    return Object.freeze(this.#values);
  }

  static get defaultConfig() {
    return {
      VERSION: "1.0.0",
      env: process.env.NODE_ENV || "development"
    };
  }

  static get configSchema() {
    return {
      $id: "https://example.com/schema",
      type: "object",
      properties: {
        foo: { type: "string" },
        baz: { type: "boolean" }
      },
      required: ["foo", "baz"]
    };
  }

  #[private] validate = (values) => {
    const validator = JSONSchemaFactory();

    try {
      const result = validator.validate(values, Config.configSchema, { abortEarly: true });
      if (!result.valid) {
        console.error('Config validation error:', result.errors);
        throw result.errors;
      }
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
    return values;
  };

  #[private] setValues = (values) => (this.#values = { ...this.#values, ...values });

  constructor() {
    this.#validate(Object.assign({}, Config.defaultConfig));
    this.#setValues(Config.defaultConfig);
  }
}

class LifecycleEvent {
  constructor(event) {
    this.event = event;
  }
}

class LifecycleHandler {
  #[private] target;
  #[private] handler;

  constructor(handler, target) {
    this.#target = target;
    this.#handler = handler;
  }

  attach(target = this.#target) {
    return new Proxy(this.#handler, {
      apply: (target, thisArg, argumentsList) => {
        return target(...argumentsList);
      }
    }).bind(target);
  }

  #[private] setTarget = (target) => {
    this.#target = target;
  }
}

class JSONSchemaFactory {
  constructor() {
    this.schema = {
      $schema: "https://json-schema.org/draft-07/schema#",
      ...Config.configSchema
    };
  }

  validate = (data, schema, options) => {
    const resolver = new JSONSchemaResolver(schema);
    const validator = new JSONValidator(resolver, options);
    return validator.compile(schema).validate(data);
  }
}

class LifecycleManager {
  #[private] config;
  #[private] lifecycle = {
    configured: false,
    loaded: false,
    shuttingDown: false
  };

  get lifecycle() {
    return this.#lifecycle;
  }

  get status() {
    return this.config.status;
  }

  constructor() {
    this.#config = new Config();
  }

  attach(event, handler) {
    return this.onLifecycleEvent(event, handler);
  }

  #[private] fireLifecycleEvent = (event, data = {}) => {
    if (this.#lifecycle[event] && typeof this.#lifecycle[event] === "function") {
      return Promise.resolve(this.#lifecycle[event](data));
    } else {
      return Promise.resolve();
    }
  };

  onLifecycleEvent = (event, handler) => {
    const lifecycleHandler = new LifecycleHandler(handler, this.#lifecycle);
    this.#lifecycle[event] = lifecycleHandler.attach(this.#lifecycle);
    return this;
  };

  validateConfig = (config, schema) => {
    const validator = JSONSchemaFactory();
    return validator.validate(config, schema, { abortEarly: true });
  };

  async configure(config) {
    const validatedConfig = this.validateConfig(config, Config.configSchema);
    this.#config.setValues(validatedConfig);
    return this.fireLifecycleEvent("CONFIGURED", validatedConfig);
  }

  async load() {
    await this.configure(Config.defaultConfig);
    try {
      console.log("Loading...");
      await new Promise(resolve => setTimeout(resolve, 1000));
      console.log("Loading complete...");
      this.#lifecycle.loaded = true;
      return this.fireLifecycleEvent("LOADED", Config.defaultConfig);
    } catch (e) {
      console.error('Load error:', e);
    }
  }

  async shutdown() {
    if (!this.#lifecycle.shuttingDown) {
      console.log("Shutdown initiated...");
      this.#lifecycle.shuttingDown = true;
      await this.fireLifecycleEvent("SHUTTING_DOWN");
      console.log("Shutdown complete...");
      Object.assign(this.#lifecycle, { shuttingDown: false, loaded: false, configured: false });
      this.#lifecycle.configured = false;
    }
  }

  async destroy() {
    Object.assign(this.#lifecycle, { shuttingDown: false, loaded: false, configured: false });
    this.#lifecycle.configured = false;
    return console.log("Lifecycle Manager instance destroyed.");
  }

  async start() {
    await this.configure(Config.defaultConfig);
    try {
      await this.load();
      const startOrder = ["on", "load"];
      for (const methodName of startOrder) {
        if (typeof this[methodName] === "function") {
          await this[methodName](this.#config.values);
        }
      }
      return console.log("Lifecycle Manager started.");
    } catch (e) {
      console.error('Start error:', e);
    }
  }
}

class NexusCore extends LifecycleManager {
  constructor() {
    super();
    this.onLifecycleEvent("CONFIGURED", () => {});
  }
}

async function main() {
  console.log("Initializing nexus core...");
  const nexusCore = new NexusCore();
  await nexusCore.on("LOAD", async (config) => console.log("Lifecycle LOAD event triggered with config:", config));
  await nexusCore.start();
}

main();