// config.js
class ConfigModule {
  constructor() {
    this.staticConfig = {
      VERSION: '1.0.0',
      env: 'development',
    };

    this.defaultConfig = {
      foo: 'bar',
      baz: true,
    };

    this.configSchema = {
      type: 'object',
      properties: {
        foo: { type: 'string' },
        baz: { type: 'boolean' },
      },
      required: ['foo', 'baz'],
    };
  }
}

class ConfigSchema {
  constructor(module) {
    this.module = module;
  }

  define(values) {
    Object.assign(this.module.configSchema.properties, values);
  }
}

class ConfigValidator {
  constructor(module) {
    this.module = module;
    this.validator = new (require('jsonschema').Validator)();
    this.validator.checkSchema(module.configSchema);
  }

  validate(values) {
    try {
      this.validator.validate(values, this.module.configSchema);
    } catch (e) {
      throw e;
    }
  }
}

export { ConfigModule, ConfigSchema, ConfigValidator };



// lifecycle-handler.js
class LifecycleHandler {
  constructor(handler = () => {}) {
    this.#handler = handler;
  }

  bind(context) {
    this.handler = () => this.#handler.call(context);
  }

  get handler() {
    return this.#handler;
  }
}

export default LifecycleHandler;



// event.js
class EventEmitter {
  #event;
  #handlers;

  constructor(event) {
    this.#event = event;
    this.#handlers = [];
  }

  on(eventName, handler) {
    this.#handlers.push({ eventName, handler });
    return this;
  }

  emit(eventName, ...args) {
    const handlers = this.#handlers.filter((handler) => handler.eventName === eventName);
    handlers.forEach((handler) => handler.handler(...args));
  }

  removeListener(eventName, handler) {
    this.#handlers = this.#handlers.filter((h) => h.eventName !== eventName || h.handler !== handler);
  }
}

export default EventEmitter;



// lifecycle.js
class Lifecycle {
  #configured = false;
  #loaded = false;
  #shuttingDown = false;

  isConfigured() {
    return this.#configured;
  }

  isLoaded() {
    return this.#loaded;
  }

  isShuttingDown() {
    return this.#shuttingDown;
  }

  configure() {
    this.#configured = true;
    return this;
  }

  loaded() {
    this.#loaded = true;
    return this;
  }

  shuttingDown() {
    this.#shuttingDown = true;
    return this;
  }

  reset() {
    this.#configured = false;
    this.#loaded = false;
    this.#shuttingDown = false;
  }
}

export default Lifecycle;



// nexus-core.js
import Config from './config.js';
import EventEmitter from './event.js';
import Lifecycle from './lifecycle.js';
import LifecycleHandler from './lifecycle-handler.js';

class NexusCore {
  #lifecycle = new Lifecycle();
  #status = 'INIT';
  #config = null;
  #disposed = false;
  #eventEmitter = new EventEmitter('NEXUS_CORE');
  #validators = [];

  get status() {
    return this.#status;
  }

  set status(value) {
    if (this.#disposed) {
      throw new Error('NexusCore instance is disposed');
    }
    this.#status = value;
    const currentPosition = this.#status;
    if (value !== 'INIT') {
      console.log(`NexusCore instance is ${value}.`);
    }
    if (currentPosition === 'INIT' && value !== 'INIT') {
      this.#lifecycle = this.#lifecycle.configure();
    }
  }

  get lifecycle() {
    return this.#lifecycle;
  }

  async configure(config) {
    if (this.#disposed) {
      throw new Error('NexusCore instance is disposed');
    }
    this.#config = new Configuration(config);
    await this.#config.validate();
    this.#lifecycle = this.#lifecycle.configure();
    this.#eventEmitter.emit('CONFIGURED');
    this.status = 'CONFIGURED';
  }

  async start() {
    if (this.#disposed) {
      throw new Error('NexusCore instance is disposed');
    }
    const startMethodOrder = ['load', 'shutdown'];
    const lifecycleEventHandlers = [
      () => console.log('Lifecycle CONFIGURED event emitted'),
      () => console.log('NexusCore instance destroyed.'),
    ];
    this.#eventEmitter.on('CONFIGURED').on(lifecycleEventHandlers[0]);
    this.#eventEmitter.on('DESTROYED').on(lifecycleEventHandlers[1]);

    for (const methodName of startMethodOrder) {
      await this[methodName]();
      this.#eventEmitter.emit('CONFIGURED');
    }

    return this.#eventEmitter;
  }

  async load() {
    try {
      if (this.#disposed) {
        throw new Error('NexusCore instance is disposed');
      }
      console.log('Loading...');
      await new Promise(resolve => setTimeout(resolve, 1000));
      console.log('Loading complete...');
      this.#lifecycle = this.#lifecycle.loaded();
      this.status = 'LOADED';
    } catch (e) {
      throw e;
    }
  }

  async shutdown() {
    try {
      if (this.#disposed) {
        throw new Error('NexusCore instance is disposed');
      }
      console.log('Shutdown initiated...');
      this.#lifecycle = this.#lifecycle.shuttingDown();
      console.log('Shutdown complete...');
      this.status = 'SHUTDOWN';
      this.#eventEmitter.emit('DESTROYED');
    } catch (e) {
      throw e;
    }
  }

  async destroy() {
    this.#disposed = true;
    this.#eventEmitter.removeAllListeners();
    this.#lifecycle.reset();
    for (const validator of this.#validators) {
      validator.validator.destroy();
    }
  }
}

class Configuration {
  static validate(config) {
    const { properties } = Config.configSchema;
    try {
      const validator = new (require('jsonschema').Validator)();
      validator.checkSchema(Config.configSchema);
      validator.validate(config, Config.configSchema);
    } catch (e) {
      throw e;
    }
  }

  constructor(values = {}) {
    Object.assign(values, Config.defaultConfig);
    const schema = new ConfigSchema();
    for (const property in Config.configSchema.properties) {
      if (Config.configSchema.properties[property].required) {
        if (!values[property]) {
          schema.define({ [property]: (val) => !this.validateRequired(val) });
        }
      }
    }

    this.configSchema = Config.configSchema;
    this.schema = schema;
    this.validator = new ConfigValidator(this.schema.module);
    this.validator.validate(values);
    this.values = values;
  }

  validateRequired(value) {
    return value !== '';
  }

  addValidator(validator) {
    this.#validators.push(validator);
  }
}

export default NexusCore;



// index.js
import NexusCore from './nexus-core.js';

const nexusCore = new NexusCore();
nexusCore.on('CONFIGURED').on(() => {
  console.log('Lifecycle CONFIGURED event emitted');
});
nexusCore.on('DESTROYED').on(() => {
  console.log('NexusCore instance destroyed.');
});
nexusCore.configure(Config.defaultConfig);
nexusCore.start().catch((error) => {
  console.error('Error:', error);
  nexusCore.destroy();
}).finally(() => {
  console.log('NexusCore instance destroyed.');
});