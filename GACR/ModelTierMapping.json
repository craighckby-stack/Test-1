import { Validator } from 'jsonschema';

class Config {
  #staticConfig = {
    VERSION: "1.0.0",
    env: process.env.NODE_ENV || "development"
  };

  #configSchema = {
    type: 'object',
    properties: {
      foo: { type: 'string' },
      baz: { type: 'boolean' }
    }
  };

  #config = {};

  constructor() {}

  /**
   * @param {object} values
   */
  setValues(values) {
    Object.assign(this.#config, values);
  }

  async loadDefaultConfig() {
    const defaultConfig = { ...this.#staticConfig };
    return Promise.resolve(JSON.stringify(defaultConfig));
  }

  async loadConfig() {
    try {
      const defaultConfig = await this.loadDefaultConfig();
      await validateConfig(defaultConfig);
      return JSON.parse(defaultConfig);
    } catch (e) {
      throw e;
    }
  }

  async validate() {
    try {
      const validator = new Validator();
      validator.checkSchema(this.#configSchema);
      await validator.validateAsync(this.#config, this.#configSchema);
    } catch (e) {
      console.error('Config validation error:', e);
      throw e;
    }
  }
}

const config = new Config();

function validateConfig(config) {
  try {
    const validator = new Validator();
    const schema = Config.Schema;
    validator.checkSchema(schema);
    validator.validateAsync(config, schema);
  } catch (e) {
    console.error('Config validation error:', e);
    throw e;
  }
}

class LifecycleHandler {
  #handler = (value) => {};

  static of(handler) {
    return new LifecycleHandler(handler);
  }

  async bind(target = this) {
    this.#handler = this.#handler.bind(target);
  }

  async execute(value) {
    this.#handler(value);
  }
}

class NexusCore {
  static #lifeCycleState = {
    configured: false,
    loaded: false,
    shuttingDown: false
  };

  static #status = "INIT";

  static get status() {
    return NexusCore.#status;
  }

  static set status(value) {
    NexusCore.#status = value;
    const currentValue = NexusCore.#status;
    const lifeCycleState = NexusCore.#lifeCycleState;
    if (value !== 'INIT') {
      console.log(`NexusCore instance is ${value}.`);
      if (value === 'SHUTDOWN') {
        lifeCycleState.shuttingDown = false;
      }
    }
    if (currentValue === 'INIT' && value !== 'INIT') {
      lifeCycleState.configured = true;
    }
  }

  static async configure(config) {
    await validateConfig(config);
    NexusCore.#lifeCycleState.configured = true;
    await NexusCore.#updateLifeCycleState('CONFIGURED');
  }

  static async #updateLifeCycleState(state, value) {
    NexusCore.#lifeCycleState[state] = LifecycleHandler.of((value) => {}).bind(NexusCore).execute(value);
  }

  static async load() {
    console.log("Loading...");
    await new Promise(resolve => setTimeout(resolve, 1000));
    console.log("Loading complete...");
    NexusCore.#lifeCycleState.loaded = true;
    await NexusCore.#updateLifeCycleState('LOADED');
  }

  static async shutdown() {
    if (!NexusCore.#lifeCycleState.shuttingDown) {
      console.log("Shutdown initiated...");
      NexusCore.#lifeCycleState.shuttingDown = true;
      await NexusCore.#updateLifeCycleState('SHUTTING_DOWN');
      console.log("Shutdown complete...");
      NexusCore.#status = "SHUTDOWN";
    }
  }

  static async start() {
    const methodOrder = ["configure", "load", "shutdown", "destroy"];
    for (const methodName of methodOrder) {
      if (methodName in NexusCore) {
        await NexusCore[methodName]();
      }
    }
  }

  static async destroy() {
    NexusCore.#lifeCycleState = {
      configured: false,
      loaded: false,
      shuttingDown: false
    };
    NexusCore.#status = "DESTROYED";
  }

  static async getInstance() {
    return new NexusCore();
  }

  static Schema = {
    type: 'object',
    properties: {
      foo: { type: 'string' },
      baz: { type: 'boolean' }
    }
  }
}

class ConfigManager {
  async #configPath() {
    let path = '';
    try {
      const home = process.env.HOME;
      if (home) {
        path += `${home}/nexus-core/config.json`;
      }
      if (path) {
        const fs = require('fs').promises;
        const data = await fs.readFile(path, 'utf8');
        return JSON.parse(data);
      }
    } catch (err) {
      return null;
    }
  }

  async loadConfig() {
    try {
      const config = await this.#configPath();
      if (!config) {
        config = new Config();
        return await (await ConfigManager.getInstance()).loadConfig();
      } else {
        const instance = Config.getInstance();
        instance.#config = config;
        return await instance.loadConfig();
      }
    } catch (err) {
      if (err) throw err;
    }
  }

  async saveConfig(config) {
    try {
      const fs = require('fs').promises;
      const fileLocation = process.env.HOME || process.env.APPDATA;
      const path = `${fileLocation}/nexus-core/config.json`;
      const data = await JSON.stringify(config, null, 2);
      await fs.writeFile(path, data);
    } catch (err) {
      if (err) throw err;
    }
  }

  static getInstance() {
    return new ConfigManager();
  }
}

async function main() {
  try {
    const nexusCore = new NexusCore();
    const configManager = ConfigManager.getInstance();
    let config = await configManager.loadConfig();
    await nexusCore.configure(config);
    await new ConfigManager().saveConfig(config);
    await config.validate();
    console.log('Config: ', config.#config);
    await nexusCore.start();
    await nexusCore.load();
    await nexusCore.shutdown();
    await nexusCore.destroy();
    return true;
  } catch (err) {
    throw err;
  }
}

Config.getInstance().setValues({
  foo: 'bar',
  baz: true,
});

config.validate();

main().catch((err) => {
  console.error('Main error:', err);
});