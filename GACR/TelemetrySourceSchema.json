{
  "$id": "GACR/TelemetrySourceSchema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Telemetry Aggregation Output Schema (Synergy Refined)",
  "description": "Defines the required structure for data ingested by the Constraint Validator from the Aggregator, incorporating conditional type enforcement for maximum data integrity.",
  "type": "array",
  "items": {
    "type": "object",
    "properties": {
      "constraint_id": { "type": "string", "minLength": 1, "description": "Reference to the governing constraint." },
      "monitor_id": { "type": "string", "minLength": 1 },
      "timestamp_ms": { "type": "integer", "format": "int64", "minimum": 0, "description": "Aggregation timestamp (must be non-negative)." },
      "metric_value": { "description": "The extracted metric value. Type is strictly enforced based on data_type via conditional logic." },
      "data_type": { "type": "string", "enum": ["GAUGE", "COUNTER", "BOOLEAN", "HISTOGRAM"] },
      "source_metadata": { "type": "object", "additionalProperties": true, "description": "Raw metadata about the data collection." }
    },
    "required": ["constraint_id", "monitor_id", "timestamp_ms", "metric_value", "data_type"],
    "allOf": [
      {
        "if": { "properties": { "data_type": { "const": "BOOLEAN" } }, "required": ["data_type"] },
        "then": { "properties": { "metric_value": { "type": "boolean" } } }
      },
      {
        "if": { "properties": { "data_type": { "enum": ["GAUGE", "COUNTER"] } }, "required": ["data_type"] },
        "then": { "properties": { "metric_value": { "type": "number" } } }
      },
      {
        "if": { "properties": { "data_type": { "const": "HISTOGRAM" } }, "required": ["data_type"] },
        "then": { "properties": { "metric_value": { "type": ["number", "string", "object"] } } }
      }
    ]
  }
}