class Config {
  #staticConfig = {
    VERSION: "1.0.0",
    env: process.env.NODE_ENV || "development"
  };

  get staticConfig() {
    return { ...this.#staticConfig };
  }

  #defaultConfig = {
    foo: 'bar',
    baz: true
  };

  get defaultConfig() {
    return { ...this.#defaultConfig };
  }

  #configSchema = {
    type: "object",
    properties: {
      foo: { type: "string" },
      baz: { type: "boolean" }
    }
  };

  get configSchema() {
    return { ...this.#configSchema };
  }

  validateConfig(config) {
    try {
      const validator = new (require('jsonschema').Validator)();
      validator.checkSchema(this.configSchema);
      validator.validate(config, this.configSchema);
    } catch (e) {
      throw e;
    }
  }

  async constructor(values) {
    const config = await this.validateConfig(values);
    this.#config = {
      ...this.staticConfig,
      ...this.defaultConfig,
      ...config
    };
    return this.#config;
  }

  get config() {
    return this.#config;
  }

  destroy() {
    delete this.#config;
  }
}

class LifecycleEvent {
  constructor(event, handler) {
    this.event = event;
    this.handler = handler;
  }
}

class LifecycleHandler {
  constructor(event, handler) {
    this.event = event;
    this.handler = handler;
    this.binded = false;
  }

  bind(target = this) {
    if (!this.binded) {
      this.handler = this.handler.bind(target);
      this.binded = true;
    }
  }

  execute() {
    this.handler();
  }

  destroy() {
    delete this.handler;
  }
}

const LIFECYCLE_CONFIGURED = Symbol("CONFIGURED");
const LIFECYCLE_LOADED = Symbol("LOADED");
const LIFECYCLE_SHUTTING_DOWN = Symbol("SHUTDOWN");
const LIFECYCLE_DESTROYED = Symbol("DESTROYED");

class LifecycleManager {
  #config;
  #lifecycle = {
    [LIFECYCLE_CONFIGURED]: false,
    [LIFECYCLE_LOADED]: false,
    [LIFECYCLE_SHUTTING_DOWN]: false,
    [LIFECYCLE_DESTROYED]: false
  };
  #status = LIFECYCLE_CONFIGURED;
  #handlers = {};

  constructor() {
    this.#config = null;
  }

  async configure(config) {
    await this.validateConfig(config);
    this.#setLifecycleStatus(LIFECYCLE_CONFIGURED, LIFECYCLE_CONFIGURED);
    if (typeof config === "function") {
      const validatedConfig = await new Config(config()).constructor();
      this.#config = validatedConfig;
      this.#setLifecycleStatus(LIFECYCLE_CONFIGURED, LIFECYCLE_CONFIGURED);
      return { validatedConfig };
    } else {
      this.#config = config;
      this.#setLifecycleStatus(LIFECYCLE_CONFIGURED, LIFECYCLE_CONFIGURED);
      return { config };
    }
  }

  async validateConfig(config) {
    const configSchema = new Config().configSchema;
    try {
      const validator = new (require('jsonschema').Validator)();
      validator.checkSchema(configSchema);
      validator.validate(config, configSchema);
    } catch (e) {
      throw e;
    }
  }

  on(event, handler) {
    const lifecycleHandler = new LifecycleHandler(event, handler);
    this.#handlers[event] = lifecycleHandler;
    return lifecycleHandler;
  }

  executeLifecycleEvent(event) {
    if (this.#handlers[event]) {
      this.#handlers[event].bind(this).execute();
    }
  }

  async load() {
    this.#setLifecycleStatus(LIFECYCLE_LOADED, LIFECYCLE_LOADED);
    if (!this.#lifecycle[LIFECYCLE_DESTROYED]) {
      this.executeLifecycleEvent(LIFECYCLE_CONFIGURED);
      await new Promise(resolve => setTimeout(resolve, 1000));
      this.#setLifecycleStatus(LIFECYCLE_LOADED, LIFECYCLE_LOADED);
      this.executeLifecycleEvent(LIFECYCLE_LOADED);
    }
  }

  async shutdown() {
    this.#setLifecycleStatus(LIFECYCLE_SHUTTING_DOWN, LIFECYCLE_SHUTTING_DOWN);
    if (!this.#lifecycle[LIFECYCLE_DESTROYED]) {
      this.#lifecycle[LIFECYCLE_SHUTTING_DOWN] = true;
      this.#handlers[LIFECYCLE_SHUTTING_DOWN].destroy();
      this.#lifecycle[LIFECYCLE_DESTROYED] = false;
      await new Promise(resolve => setTimeout(resolve, 1000));
      this.#setLifecycleStatus(LIFECYCLE_SHUTTING_DOWN, LIFECYCLE_SHUTTING_DOWN);
      this.#lifecycle[LIFECYCLE_SHUTTING_DOWN] = false;
      this.#status = LIFECYCLE_SHUTTING_DOWN;
    }
  }

  destroy() {
    this.#setLifecycleStatus(LIFECYCLE_DESTROYED, LIFECYCLE_DESTROYED);
    this.#lifecycle[LIFECYCLE_DESTROYED] = true;
    this.#status = LIFECYCLE_DESTROYED;
    this.#handlers[LIFECYCLE_DESTROYED].execute();
  }

  #setLifecycleStatus(from, to) {
    const statuses = Object.freeze({
      [LIFECYCLE_CONFIGURED]: "CONFIGURED",
      [LIFECYCLE_LOADED]: "LOADED",
      [LIFECYCLE_SHUTTING_DOWN]: "SHUTDOWN",
      [LIFECYCLE_DESTROYED]: "DESTROYED"
    });
    const fromStatus = statuses[from];
    const toStatus = statuses[to];
    this.#lifecycle[fromStatus] = false;
    this.#lifecycle[toStatus] = true;
  }
}

class NexusCore extends LifecycleManager {
  get status() {
    return this.#status;
  }

  get lifecycle() {
    return this.#lifecycle;
  }

  get handlers() {
    return this.#handlers;
  }
}

const nexusCore = new NexusCore();

const lifecycleHandler1 = nexusCore.on(LIFECYCLE_DESTROYED, () => {
  console.log("NexusCore instance destroyed.");
});

const lifecycleHandler2 = nexusCore.on(LIFECYCLE_LOADED, () => {
  console.log("NexusCore instance loaded.");
});

nexusCore.configure(Config.defaultConfig);

async function main() {
  await nexusCore.configure(Config.defaultConfig);
  const validatedConfig = await new Config(Config.defaultConfig).constructor();
  console.log("Config:", validatedConfig);
  await nexusCore.load();
  console.log("NexusCore loaded");
  await nexusCore.shutdown();
  console.log("NexusCore shutdown");
  nexusCore.destroy();
  console.log("NexusCore destroyed");
}

main();