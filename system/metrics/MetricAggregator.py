# system/metrics/MetricAggregator.py

class MetricAggregator:
    """
    Manages the collection, standardization, and final calculation of 
    Total Evolved Mandate Metric (TEMM) score during P3 (Execution) 
    and P4 (Evaluation). TEMM is the primary metric used for Axiom I (UMA).
    """

    def __init__(self, logger):
        self.raw_metrics = {}
        self.logger = logger
        self.standardization_schema = {
            "EfficiencyScore": (0.0, 100.0),
            "ResourceUtilization": (0.0, 1.0),
            "MandateFulfillmentRatio": (0.5, 1.0)
        }

    def ingest_runtime_data(self, stage: str, data: dict):
        """
        Ingests data points generated by SGS during execution stages (S05-S07).
        """
        if stage not in self.raw_metrics:
            self.raw_metrics[stage] = []
        
        self.raw_metrics[stage].append(data)
        self.logger.log_debug(f"Metrics ingested for {stage}")

    def calculate_temm(self) -> float:
        """
        Aggregates and standardizes raw metrics against the schema to produce the final TEMM score.
        TEMM is a single float representing overall utility maximization.
        """
        if not self.raw_metrics:
            self.logger.log_warning("No raw metrics available. TEMM set to 0.0.")
            return 0.0

        # NOTE: Simplified aggregation for core definition. 
        # Real logic requires complex weighted averages based on CSR defined weights.
        
        # Example calculation placeholder:
        score_a = sum(d.get('EfficiencyScore', 0) for stage_data in self.raw_metrics.values() for d in stage_data)
        count = sum(len(stage_data) for stage_data in self.raw_metrics.values())
        
        if count == 0:
            return 0.0

        normalized_average_score = (score_a / count) / 100.0 # Scale to 0.0 - 1.0
        
        self.logger.log_info(f"TEMM Calculated: {normalized_average_score}")
        return normalized_average_score

    def get_report(self) -> dict:
        """
        Returns the final calculated TEMM score and supporting raw data for GAX auditing.
        """
        return {
            "TEMM": self.calculate_temm(),
            "RawDataSnapshot": self.raw_metrics,
            "Schema": self.standardization_schema
        }
