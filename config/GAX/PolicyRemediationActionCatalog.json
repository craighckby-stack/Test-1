class PolicyRemediationConfig {
  constructor(values = {}) {
    this.merge(values);
  }

  merge(values) {
    Object.assign(this, values);
  }

  static get schema() {
    const pattern = /\w+([\s\S]*?)\w+/g;
    const schema = {};
    let props;

    while ((props = pattern.exec(JSON.stringify(window.rawText))) !== null) {
      const key = props[1].trim();
      const value = JSON.parse(props[0]);

      const validator = new (require('jsonschema').Validator)();
      validator.checkSchema({
        type: 'object',
        properties: {
          [key]: { type: 'string' },
          risk: { type: 'enum', enum: ['high', 'mid', 'low'] },
          riskProfile: { type: 'object' },
        },
      });

      schema[key] = {
        type: 'object',
        properties: {
          code: { type: 'string', pattern: 'if\\(true\\)\\{.*?\\}', flags: 'js' },
          codegen: { type: 'function', required: true },
          meta: { type: 'object', required: true },
        },
      };
    }

    return { ...schema };
  }
}

class NexusCoreLifecycleHandler {
  constructor(handler) {
    this.handler = handler;
  }

  bind(target = this) {
    if (target instanceof this.constructor) {
      return this.handler.bind(target);
    }

    return this.handler.bind(target.prototype);
  }

  execute() {
    this.handler();
  }
}

class NexusCore {
  #lifecycle = {
    configured: false,
    loaded: false,
    shutdown: false,
    version: 0,
  };

  #status = 'INIT';

  static get protocol() {
    return '50/15';
  }

  static get pattern() {
    this.#pattern = 'RECURSIVE_BOOTSTRAP_KERNEL';
    return this.#pattern;
  }

  get status() {
    return this.#status;
  }

  set status(value) {
    if (value !== this.#status) {
      this.#status = value;
      const currentValue = this.#status;
      const lifecycle = this.#lifecycle;
      switch (value) {
        case 'CONFIGURED':
          lifecycle.version++;
          console.log(`NexusCore instance is ${value}.`);
          break;
        case 'LOADED':
          lifecycle.version++;
          console.log(`NexusCore instance is ${value}.`);
          break;
        case 'SHUTTING_DOWN':
          lifecycle.version++;
          console.log(`NexusCore instance is ${value}.`);
          break;
        case 'SHUTDOWN':
          lifecycle.version++;
          console.log(`NexusCore instance is ${value}.`);
          break;
        case 'DESTROYED':
          lifecycle.version++;
          console.log(`NexusCore instance is ${value}.`);
          break;
        default:
          break;
      }
    }
  }

  get lifecycle() {
    return this.#lifecycle;
  }

  validatePolicyConfig(policyConfig) {
    const configSchema = PolicyRemediationConfig.schema;
    try {
      const jsonSchema = new (require('json-schema').Core)();

      jsonSchema.validatePolicyConfig(policyConfig, configSchema);
    } catch (e) {
      console.error('Policy config validation error:', e);
      throw e;
    }
  }

  static get protocolMethods() {
    return (obj) => {
      const proto = Object.getPrototypeOf(obj);

      const methods = [];

      while (proto !== Object.prototype && obj.constructor !== Object) {
        Object.getOwnPropertyNames(proto).forEach((name) => {
          const fn = proto[name];

          if (typeof fn === 'function') {
            methods.push(obj[name]);
          }
        });

        proto = Object.getPrototypeOf(proto);
      }

      return methods;
    };
  }

  async milestoneCycle() {
    const regex = /\{[\s\S]*\}/g;
    const jsonPayloads = window.rawText.match(regex);
    const plugins = [];

    jsonPayloads.forEach((payload) => {
      const pluginName = this.#lifecycle.version;
      const pluginCode = `function ${pluginName}() { return 'Hello World!'; }`;
      const plugin = {
        name: pluginName,
        code: pluginCode,
        riskProfile: { highRisk: true },
      };

      plugins.push(plugin);
      const strategicInsight = JSON.parse(payload);

      this.strategicLedgerInjection(strategicInsight, plugin);
    });

    plugins.forEach((plugin) => {
      console.log({
        name: plugin.name,
        code: plugin.code,
        riskProfile: plugin.riskProfile,
      });
    });

    this.onLifecycleEvent('MILESTONE_CYCLE');
  }

  strategicLedgerInjection(strategicInsight, plugin = {}) {
    Object.assign(strategicInsight, plugin);
    const insights = {
      ...this.#lifecycle.insights,
      ...strategicInsight,
    };
    this.#lifecycle.version++;
    this.#lifecycle.insights = insights;
  }

  get on() {
    return (event, handler) => {
      this.onLifecycleEvent(event, handler);
    };
  }

  async load() {
    console.log('Loading...');
    await new Promise(resolve => setTimeout(resolve, 1000));
    console.log('Loading complete...');
    this.#lifecycle.loaded = true;
    this.executeLifecycleEvent('LOADED');
  }

  async start() {
    const startMethods = NexusCore.protocolMethods(this);

    for (const methodName of startMethods) {
      if (methodName instanceof Function && methodName.prototype.constructor.name === 'NexusCore') {
        await this[methodName]();
      }
    }
  }

  async destroy() {
    this.#lifecycle = {
      configured: false,
      loaded: false,
      shutdown: false,
      version: 0,
    };
  }

  async shutDown() {
    const shutdownMethods = NexusCore.protocolMethods(this);

    for (const methodName of shutdownMethods) {
      if (methodName instanceof Function) {
        await this[methodName]();
      }
    }
  }
}

window.rawText = {
  id: 'plugin_candidate',
  foo: 'bar',
  baz: true,
};

const nexusCore = new NexusCore();
nexusCore.on('DESTROYED', () => {
  console.log('NexusCore instance destroyed.');
});

nexusCore.configure(PolicyRemediationConfig.defaultConfig);
nexusCore.start();
nexusCore.load();
nexusCore.shutDown();
nexusCore.destroy();