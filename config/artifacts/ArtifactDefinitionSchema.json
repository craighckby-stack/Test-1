Here is the mutated code:


class Config {
  static get staticConfig() {
    return {
      VERSION: "1.0.0",
      env: process.env.NODE_ENV || "development",
    };
  }

  constructor(values = {}) {
    const { foo, baz, ...rest } = values;
    this.values = { foo, baz, ...rest };
  }

  setup(values) {
    this.values = { ...values };
  }

  static #defaultConfig = {
    foo: 'bar',
    baz: true,
  };

  static #configSchema = {
    type: "object",
    properties: {
      foo: { type: "string" },
      baz: { type: "boolean" },
    },
    required: ["foo", "baz"],
    additionalProperties: false,
  };

  validate() {
    const { errors } = tryValidate(this.values, Config.#configSchema);
    if (errors.length > 0) {
      throw new Error("Invalid configuration: " + errors[0].message);
    }
  }
}

function tryValidate(values, schema) {
  const validator = new Validator();
  const errors = validator.validate(values, schema).errors;
  return { errors };
}

class LifecycleEvent {
  constructor(event, handler) {
    this.event = event;
    this.handler = handler;
  }
}

class LifecycleHandler {
  constructor(handler) {
    this.handler = handler;
  }

  bindContext(context) {
    this.handler = this.handler.bind(context);
  }

  execute() {
    return this.handler();
  }
}

class NexusCore {
  constructor() {
    this.#lifecycle = {
      configured: false,
      loaded: false,
      shuttingDown: false,
    };

    this.#status = "INIT";

    lifecycleEvents.on("CONFIGURED", async () => {
      console.log("Configuration initialized");
      await this.configure(new Config({ foo: "baz", baz: false }));
    });

    lifecycleEvents.on("LOADED", async () => {
      console.log("Application loaded");
      await this.start();
    });

    lifecycleEvents.on("SHUTDOWN_INITIATED", async () => {
      console.log("Shutdown process initiated");
      await this.shutdown();
    });

    this.#lifecycle = lifecycleEvents;
  }

  get status() {
    return this.#status;
  }

  set status(value) {
    if (this.#lifecycle[value]) {
      console.log(`NexusCore instance is ${value}.`);
      if (value === "SHUTDOWN") {
        this.#lifecycle.shuttingDown = false;
      }
    } else {
      this.#status = value;
      this.#lifecycle.configured = false;
      this.#lifecycle.loaded = false;
      this.#lifecycle.shuttingDown = false;
    }
  }

  async load() {
    try {
      console.log("Loading...");
      await new Promise(resolve => setTimeout(resolve, 1000));
      console.log("Loading complete...");
      this.#lifecycle.loaded = true;
      this.#lifecycle.emit("LOADED");
    } catch (e) {
      console.error("Load error:", e);
    }
  }

  async shutdown() {
    if (!this.#lifecycle.shuttingDown) {
      console.log("Shutdown initiated...");
      this.#lifecycle.shuttingDown = true;
      this.#lifecycle.emit("SHUTTING_DOWN");
      console.log("Shutdown complete...");
      this.status = "SHUTDOWN";
    }
  }

  async start() {
    const startMethodOrder = ["configure", "load", "shutdown"];
    for (const methodName of startMethodOrder) {
      if (this[methodName] instanceof Function) {
        await this[methodName]();
      }
    }
  }

  async destroy() {
    this.status = "DESTROYED";
    this.#lifecycle = {
      configured: false,
      loaded: false,
      shuttingDown: false,
    };
    this.#lifecycle.emit("DESTROYED");
  }

  async on(event, handler) {
    const lifecycleHandler = new LifecycleHandler(handler);
    lifecycleHandler.bindContext(this);
    this.#lifecycle.on(event, lifecycleHandler);
  }

  async configure(config) {
    if (!(await config.validate())) {
      throw new Error("Invalid configuration");
    }
    this.#lifecycle.emit("CONFIGURED");
    this.#status = "CONFIGURED";
    this.config = config;
  }
}

const nexusCore = new NexusCore();
nexusCore.on("DESTROYED", () => {
  console.log("NexusCore instance destroyed.");
});
nexusCore.configure(Config.staticConfig);
nexusCore.start();
nexusCore.load();
nexusCore.shutdown();
nexusCore.destroy();

class lifecycleEvents {
  on(event, handler) {
    this[event] = handler;
    return handler;
  }

  emit(event) {
    if (this[event]) {
      return this[event]();
    }
  }
}

const validator = require("jsonschema").Validator;

const Config = require("./Config");

module.exports = {
  Config: Config.defaultConfig,
  NexusCore,
};