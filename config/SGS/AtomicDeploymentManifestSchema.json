{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "http://sag.ai/v94.1/AtomicDeploymentManifestSchema.json",
  "title": "Atomic Deployment Manifest (ADM) Schema - v94.1",
  "description": "Defines the deterministic, integrity-secured instructions for the SGS agent to execute the system state transition (S11), ensuring the certified state (signed in S10) is applied atomically.",
  "type": "object",
  "properties": {
    "transitionId": {
      "type": "string",
      "description": "Unique identifier linking back to the Change State Transition Log (CSTL) entry and the State Transition Execution Signature (STES)."
    },
    "targetVersion": {
      "type": "string",
      "pattern": "^v[0-9]+\\.[0-9]+(\\.[0-9]+)?$",
      "description": "The specific target system version (Psi_N+1) enforcing semantic versioning constraints."
    },
    "deploymentInstructions": {
      "type": "array",
      "description": "Ordered, deterministic sequence of cryptographic operations (patches, replacements, lifecycle actions) for atomic application.",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["stepId", "action", "path"],
        "properties": {
          "stepId": {
            "type": "integer",
            "minimum": 1,
            "description": "Sequential index for strictly deterministic execution order."
          },
          "action": {
            "type": "string",
            "enum": ["WRITE", "DELETE", "REPLACE", "RESTART_SERVICE", "APPLY_PATCH"]
          },
          "path": {
            "type": "string",
            "description": "Target filesystem path, or service identifier (contextual based on action)."
          }
        },
        "oneOf": [
          {
            "title": "File Modification Operations",
            "properties": {
              "action": {
                "enum": ["WRITE", "REPLACE", "APPLY_PATCH"]
              },
              "sourceHash": {
                "type": "string",
                "description": "Cryptographic hash (e.g., SHA-256) of the source content artifact. Mandatory for integrity checks.",
                "pattern": "^[a-fA-F0-9]{64}$"
              },
              "permissions": {
                "type": "string",
                "pattern": "^[0-7]{3,4}$",
                "description": "Octal permissions (e.g., 755) to be applied post-write."
              },
              "owner": {
                "type": "string",
                "description": "User:Group ownership."
              }
            },
            "required": ["action", "path", "sourceHash"]
          },
          {
            "title": "Deletion Operation",
            "properties": {
              "action": {
                "const": "DELETE"
              }
            },
            "required": ["action", "path"]
          },
          {
            "title": "Service Lifecycle Operation",
            "properties": {
              "action": {
                "const": "RESTART_SERVICE"
              },
              "timeoutSeconds": {
                "type": "integer",
                "default": 30,
                "description": "Maximum time to wait for the service restart/status check."
              }
            },
            "required": ["action", "path"]
          }
        ]
      }
    },
    "rollbackPlanHash": {
      "type": "string",
      "description": "Cryptographic hash (SHA-256) of the mandatory, immutable pre-computed rollback artifact (RP-Manifest), ensuring certified recovery capability.",
      "pattern": "^[a-fA-F0-9]{64}$"
    },
    "atomicCommitSignature": {
      "type": "string",
      "description": "State Transition Execution Signature (STES), derived from S10 (CRoT) confirming instruction integrity and authorizing execution."
    }
  },
  "required": ["transitionId", "targetVersion", "deploymentInstructions", "rollbackPlanHash", "atomicCommitSignature"]
}